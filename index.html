<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile PDF Watermark Hider</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        /* Container for the image and the mask box */
        #canvas-wrapper {
            position: relative;
            display: inline-block;
            border: 1px solid #ddd;
            overflow: hidden; 
            touch-action: none; /* Prevents scrolling while touching the canvas area */
        }
        
        /* The Red Mask Box */
        #mask-box {
            position: absolute;
            background-color: rgba(255, 0, 0, 0.4); /* See-through red */
            border: 2px solid red;
            box-sizing: border-box;
            z-index: 10;
        }

        /* Prevent button text selection */
        button { user-select: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-20">

    <div class="bg-white p-4 shadow mb-4 sticky top-0 z-20">
        <h1 class="text-lg font-bold text-gray-800">PDF Mask (Mobile)</h1>
    </div>

    <div class="px-4 max-w-md mx-auto">
        
        <div class="mb-4">
            <label class="block text-sm font-bold mb-2 text-gray-700">1. Upload PDF</label>
            <input type="file" id="pdfInput" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white"/>
        </div>

        <div id="editor-area" class="hidden">
            <p class="text-xs text-gray-500 mb-2">Use controls below to cover the watermark.</p>
            
            <div class="flex justify-center">
                <div id="canvas-wrapper">
                    <canvas id="pdf-render"></canvas>
                    <div id="mask-box" style="left: 50px; top: 50px; width: 100px; height: 30px;"></div>
                </div>
            </div>

            <div class="mt-6 bg-white p-4 rounded-lg shadow space-y-4">
                
                <div>
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Move Position</p>
                    <div class="grid grid-cols-3 gap-2 max-w-[200px] mx-auto">
                        <div></div>
                        <button onclick="moveBox(0, -5)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">↑</button>
                        <div></div>
                        
                        <button onclick="moveBox(-5, 0)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">←</button>
                        <div class="flex items-center justify-center text-gray-400">●</div>
                        <button onclick="moveBox(5, 0)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">→</button>

                        <div></div>
                        <button onclick="moveBox(0, 5)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">↓</button>
                        <div></div>
                    </div>
                </div>

                <hr>

                <div>
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Adjust Size</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <span class="text-xs text-center">Width</span>
                            <div class="flex gap-1">
                                <button onclick="resizeBox(-5, 0)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">-</button>
                                <button onclick="resizeBox(5, 0)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">+</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-xs text-center">Height</span>
                            <div class="flex gap-1">
                                <button onclick="resizeBox(0, -5)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">-</button>
                                <button onclick="resizeBox(0, 5)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="processPDF()" class="w-full bg-green-600 text-white text-lg font-bold py-4 rounded-lg shadow mt-4 active:bg-green-800">
                    Apply & Download
                </button>
                <p id="status" class="text-center text-sm text-gray-500 mt-2"></p>
            </div>
        </div>
    </div>

    <script>
        let pdfDoc = null;
        let pdfData = null;
        let pdfPageWidth = 0;
        let pdfPageHeight = 0;
        let canvasScale = 1.0;

        // Current state of the box (pixels relative to canvas)
        let box = { x: 20, y: 20, w: 100, h: 40 };

        const fileInput = document.getElementById('pdfInput');
        const editorArea = document.getElementById('editor-area');
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');
        const maskBox = document.getElementById('mask-box');

        // --- 1. HANDLE UPLOAD ---
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            const file = e.target.files[0];
            pdfData = await file.arrayBuffer();

            const loadingTask = pdfjsLib.getDocument({ data: pdfData });
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);

            // Scale logic: Fit to screen width (minus padding)
            const viewportRaw = page.getViewport({ scale: 1 });
            const screenWidth = window.innerWidth - 40; // 20px padding each side
            canvasScale = screenWidth / viewportRaw.width;
            
            // If scale is weirdly huge (small PDF), cap it
            if (canvasScale > 2) canvasScale = 2;

            const viewport = page.getViewport({ scale: canvasScale });

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pdfPageWidth = viewportRaw.width;
            pdfPageHeight = viewportRaw.height;

            const renderContext = { canvasContext: ctx, viewport: viewport };
            await page.render(renderContext).promise;
            
            // Initialize Box Position (Center it roughly)
            box.x = (viewport.width / 2) - 50;
            box.y = (viewport.height / 2) - 20;
            updateBoxVisual();

            editorArea.classList.remove('hidden');
        });

        // --- 2. CONTROL FUNCTIONS ---
        
        // Multiplier allows moving faster if you want to add a "Fast" toggle later
        const step = 5; 

        function moveBox(dx, dy) {
            box.x += dx * 2; // Move by 10px increments usually
            box.y += dy * 2;
            updateBoxVisual();
        }

        function resizeBox(dw, dh) {
            box.w += dw * 2;
            box.h += dh * 2;
            // Prevent negative size
            if (box.w < 10) box.w = 10;
            if (box.h < 10) box.h = 10;
            updateBoxVisual();
        }

        function updateBoxVisual() {
            maskBox.style.left = box.x + 'px';
            maskBox.style.top = box.y + 'px';
            maskBox.style.width = box.w + 'px';
            maskBox.style.height = box.h + 'px';
        }

        // --- 3. PROCESS & DOWNLOAD ---
        async function processPDF() {
            if (!pdfData) return;
            const status = document.getElementById('status');
            status.innerText = "Processing...";

            try {
                const pdfDoc = await PDFLib.PDFDocument.load(pdfData);
                const pages = pdfDoc.getPages();

                // Convert Screen Pixels -> PDF Points
                // 1. Scale back to original PDF size
                const pdfX = box.x / canvasScale;
                const pdfW = box.w / canvasScale;
                const pdfH = box.h / canvasScale;
                
                // 2. Y-Axis flip (Web Top-Left -> PDF Bottom-Left)
                const visualYOnPdf = box.y / canvasScale;
                const finalY = pdfPageHeight - (visualYOnPdf + pdfH);

                pages.forEach(page => {
                    page.drawRectangle({
                        x: pdfX,
                        y: finalY,
                        width: pdfW,
                        height: pdfH,
                        color: PDFLib.rgb(1, 1, 1),
                        opacity: 1,
                    });
                });

                const pdfBytes = await pdfDoc.save();
                download(pdfBytes, "clean_mobile.pdf");
                status.innerText = "Done! Downloading...";

            } catch (err) {
                console.error(err);
                status.innerText = "Error.";
                alert("An error occurred.");
            }
        }

        function download(data, filename) {
            const blob = new Blob([data], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
