<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Mask Tool</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="./icon-192.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        #canvas-wrapper {
            position: relative;
            display: inline-block;
            border: 1px solid #ddd;
            overflow: hidden; 
            touch-action: none;
        }
        
        #mask-box {
            position: absolute;
            border: 2px solid rgba(0,0,0,0.5);
            box-sizing: border-box;
            z-index: 10;
            background-color: rgba(255, 255, 255, 1); 
            /* Pointer events none ensures clicks pass through to canvas during picking */
            pointer-events: none; 
        }

        button { user-select: none; }
        
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 40px;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }

        /* Crosshair cursor when picking color */
        .picking-mode {
            cursor: crosshair !important;
            border: 2px solid #2563eb !important; /* Blue border to show active */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-20">

    <div class="bg-white p-4 shadow mb-4 sticky top-0 z-20 flex justify-between items-center">
        <h1 class="text-lg font-bold text-gray-800">Mask Tool</h1>
        <button id="installBtn" class="hidden bg-blue-600 text-white text-sm px-4 py-2 rounded-full font-bold shadow hover:bg-blue-700 transition">
            Install App
        </button>
    </div>

    <div class="px-4 max-w-md mx-auto">
        
        <div class="mb-4">
            <label class="block text-sm font-bold mb-2 text-gray-700">1. Upload File (PDF or Image)</label>
            <input type="file" id="fileInput" accept="application/pdf, image/jpeg, image/png" class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white"/>
        </div>

        <div id="editor-area" class="hidden">
            <p id="instruction-text" class="text-xs text-gray-500 mb-2">Use controls below to place the box.</p>
            
            <div class="flex justify-center">
                <div id="canvas-wrapper">
                    <canvas id="render-canvas"></canvas>
                    <div id="mask-box" style="left: 50px; top: 50px; width: 100px; height: 30px;"></div>
                </div>
            </div>

            <div class="mt-6 bg-white p-4 rounded-lg shadow space-y-4">
                
                <div>
                     <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Patch Color</p>
                     <div class="flex gap-2">
                         <div class="flex-1">
                             <input type="color" id="colorPicker" value="#ffffff">
                         </div>
                         <button id="eyedropperBtn" onclick="toggleEyedropper()" class="bg-gray-200 text-gray-700 px-4 rounded-lg font-bold hover:bg-gray-300 active:bg-blue-200">
                             Pick from Page üñåÔ∏è
                         </button>
                     </div>
                </div>

                <hr>

                <div>
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Move Position</p>
                    <div class="grid grid-cols-3 gap-2 max-w-[200px] mx-auto">
                        <div></div>
                        <button onclick="moveBox(0, -5)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">‚Üë</button>
                        <div></div>
                        <button onclick="moveBox(-5, 0)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">‚Üê</button>
                        <div class="flex items-center justify-center text-gray-400">‚óè</div>
                        <button onclick="moveBox(5, 0)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">‚Üí</button>
                        <div></div>
                        <button onclick="moveBox(0, 5)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">‚Üì</button>
                        <div></div>
                    </div>
                </div>

                <hr>

                <div>
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Adjust Size</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <span class="text-xs text-center">Width</span>
                            <div class="flex gap-1">
                                <button onclick="resizeBox(-5, 0)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">-</button>
                                <button onclick="resizeBox(5, 0)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">+</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-xs text-center">Height</span>
                            <div class="flex gap-1">
                                <button onclick="resizeBox(0, -5)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">-</button>
                                <button onclick="resizeBox(0, 5)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="processFile()" class="w-full bg-green-600 text-white text-lg font-bold py-4 rounded-lg shadow mt-4 active:bg-green-800">
                    Apply & Download
                </button>
                <p id="status" class="text-center text-sm text-gray-500 mt-2"></p>
            </div>
        </div>
    </div>

    <script>
        // --- PWA LOGIC ---
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW fail', err));
            });
        }
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
        });
        installBtn.addEventListener('click', (e) => {
            installBtn.classList.add('hidden'); deferredPrompt.prompt(); deferredPrompt = null;
        });
        window.addEventListener('appinstalled', () => { installBtn.classList.add('hidden'); });

        // --- GLOBAL VARS ---
        let currentFileType = null; // 'pdf' or 'image'
        let fileData = null;        
        let originalWidth = 0;      
        let originalHeight = 0;     
        let canvasScale = 1.0;
        let isEyedropperActive = false;

        let box = { x: 20, y: 20, w: 100, h: 40 };

        const fileInput = document.getElementById('fileInput');
        const editorArea = document.getElementById('editor-area');
        const canvas = document.getElementById('render-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const maskBox = document.getElementById('mask-box');
        const colorPicker = document.getElementById('colorPicker');
        const wrapper = document.getElementById('canvas-wrapper');
        const instructionText = document.getElementById('instruction-text');

        // --- EYEDROPPER LOGIC ---
        function toggleEyedropper() {
            isEyedropperActive = !isEyedropperActive;
            const btn = document.getElementById('eyedropperBtn');
            
            if (isEyedropperActive) {
                wrapper.classList.add('picking-mode');
                btn.classList.add('bg-blue-200', 'border-blue-500', 'text-blue-800');
                btn.innerText = "Tap on Image now...";
                instructionText.innerText = "Tap anywhere on the image/pdf to pick that color.";
            } else {
                wrapper.classList.remove('picking-mode');
                btn.classList.remove('bg-blue-200', 'border-blue-500', 'text-blue-800');
                btn.innerText = "Pick from Page üñåÔ∏è";
                instructionText.innerText = "Use controls below to place the box.";
            }
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // Handle Click on Canvas for Color Picking
        wrapper.addEventListener('click', (e) => {
            if (!isEyedropperActive) return;

            // 1. Get click coordinates relative to the canvas
            const rect = canvas.getBoundingClientRect();
            // Scale the click coordinates to match the internal canvas resolution
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // 2. Get Pixel Data
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const hex = rgbToHex(pixel[0], pixel[1], pixel[2]);

            // 3. Update Inputs
            colorPicker.value = hex;
            maskBox.style.backgroundColor = hex; // Solid color for visual

            // 4. Turn off eyedropper
            toggleEyedropper();
        });


        // --- COLOR PICKER CHANGE ---
        colorPicker.addEventListener('input', (e) => {
            maskBox.style.backgroundColor = e.target.value;
        });

        function hexToPdfColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return PDFLib.rgb(r, g, b);
        }

        // --- FILE HANDLING (PDF & IMAGE) ---
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            const file = e.target.files[0];

            if (file.type === 'application/pdf') {
                currentFileType = 'pdf';
                await loadPDF(file);
            } else if (file.type.startsWith('image/')) {
                currentFileType = 'image';
                await loadImage(file);
            } else {
                alert("Please upload a PDF or an Image.");
            }
        });

        async function loadPDF(file) {
            fileData = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: fileData });
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);

            const viewportRaw = page.getViewport({ scale: 1 });
            originalWidth = viewportRaw.width;
            originalHeight = viewportRaw.height;
            
            fitToScreen(originalWidth); 

            const viewport = page.getViewport({ scale: canvasScale });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = { canvasContext: ctx, viewport: viewport };
            await page.render(renderContext).promise;
            
            finalizeLoad(viewport.width, viewport.height);
        }

        async function loadImage(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    fileData = img; 
                    originalWidth = img.width;
                    originalHeight = img.height;

                    fitToScreen(originalWidth);

                    canvas.width = originalWidth * canvasScale;
                    canvas.height = originalHeight * canvasScale;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    finalizeLoad(canvas.width, canvas.height);
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        function fitToScreen(realWidth) {
            const screenWidth = window.innerWidth - 40; 
            canvasScale = screenWidth / realWidth;
            if (canvasScale > 2) canvasScale = 2; 
        }

        function finalizeLoad(viewW, viewH) {
            resetBox(viewW, viewH);
            editorArea.classList.remove('hidden');
            // Ensure picker matches box
            colorPicker.dispatchEvent(new Event('input'));
        }

        function resetBox(viewW, viewH) {
            box.x = (viewW / 2) - 50;
            box.y = (viewH / 2) - 20;
            updateBoxVisual();
        }

        // --- BOX MOVEMENT ---
        function moveBox(dx, dy) {
            box.x += dx * 2; 
            box.y += dy * 2;
            updateBoxVisual();
        }

        function resizeBox(dw, dh) {
            box.w += dw * 2;
            box.h += dh * 2;
            if (box.w < 10) box.w = 10;
            if (box.h < 10) box.h = 10;
            updateBoxVisual();
        }

        function updateBoxVisual() {
            maskBox.style.left = box.x + 'px';
            maskBox.style.top = box.y + 'px';
            maskBox.style.width = box.w + 'px';
            maskBox.style.height = box.h + 'px';
        }

        // --- PROCESSING & SAVING ---
        async function processFile() {
            const status = document.getElementById('status');
            status.innerText = "Processing...";

            const realX = box.x / canvasScale;
            const realW = box.w / canvasScale;
            const realH = box.h / canvasScale;

            try {
                if (currentFileType === 'pdf') {
                    const pdfDoc = await PDFLib.PDFDocument.load(fileData);
                    const pages = pdfDoc.getPages();
                    const selectedColor = hexToPdfColor(colorPicker.value);
                    
                    const visualYOnPdf = box.y / canvasScale;
                    const finalY = originalHeight - (visualYOnPdf + realH);

                    pages.forEach(page => {
                        page.drawRectangle({
                            x: realX, y: finalY, width: realW, height: realH,
                            color: selectedColor, opacity: 1,
                        });
                    });

                    const pdfBytes = await pdfDoc.save();
                    download(pdfBytes, "masked_file.pdf", 'application/pdf');

                } else if (currentFileType === 'image') {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = originalWidth;
                    tempCanvas.height = originalHeight;
                    const tCtx = tempCanvas.getContext('2d');

                    tCtx.drawImage(fileData, 0, 0);

                    tCtx.fillStyle = colorPicker.value;
                    const realY = box.y / canvasScale;
                    tCtx.fillRect(realX, realY, realW, realH);

                    tempCanvas.toBlob((blob) => {
                        download(blob, "masked_image.jpg", 'image/jpeg');
                    }, 'image/jpeg', 0.95);
                }
                
                status.innerText = "Done! Downloading...";

            } catch (err) {
                console.error(err);
                status.innerText = "Error.";
                alert("An error occurred processing the file.");
            }
        }

        function download(data, filename, mimeType) {
            let blob;
            if (data instanceof Blob) blob = data;
            else blob = new Blob([data], { type: mimeType });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>
