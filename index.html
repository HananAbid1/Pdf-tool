<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile PDF Watermark Hider</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        #canvas-wrapper {
            position: relative;
            display: inline-block;
            border: 1px solid #ddd;
            overflow: hidden; 
            touch-action: none;
        }
        
        /* The Mask Box - Color is now set via JS */
        #mask-box {
            position: absolute;
            border: 2px solid rgba(0,0,0,0.5);
            box-sizing: border-box;
            z-index: 10;
            /* Default starting color */
            background-color: rgba(255, 255, 255, 0.7); 
        }

        button { user-select: none; }
        
        /* Color Picker Style */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 40px;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-20">

    <div class="bg-white p-4 shadow mb-4 sticky top-0 z-20 flex justify-between items-center">
        <h1 class="text-lg font-bold text-gray-800">PDF Mask App</h1>
        <button id="installBtn" class="hidden bg-blue-600 text-white text-sm px-4 py-2 rounded-full font-bold shadow hover:bg-blue-700 transition">
            Install App
        </button>
    </div>

    <div class="px-4 max-w-md mx-auto">
        
        <div class="mb-4">
            <label class="block text-sm font-bold mb-2 text-gray-700">1. Upload PDF</label>
            <input type="file" id="pdfInput" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white"/>
        </div>

        <div id="editor-area" class="hidden">
            <p class="text-xs text-gray-500 mb-2">Use controls below to place the colored box.</p>
            
            <div class="flex justify-center">
                <div id="canvas-wrapper">
                    <canvas id="pdf-render"></canvas>
                    <div id="mask-box" style="left: 50px; top: 50px; width: 100px; height: 30px;"></div>
                </div>
            </div>

            <div class="mt-6 bg-white p-4 rounded-lg shadow space-y-4">
                
                <div>
                     <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Select Color</p>
                     <input type="color" id="colorPicker" value="#ffffff">
                </div>

                <hr>

                <div>
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Move Position</p>
                    <div class="grid grid-cols-3 gap-2 max-w-[200px] mx-auto">
                        <div></div>
                        <button onclick="moveBox(0, -5)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">↑</button>
                        <div></div>
                        <button onclick="moveBox(-5, 0)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">←</button>
                        <div class="flex items-center justify-center text-gray-400">●</div>
                        <button onclick="moveBox(5, 0)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">→</button>
                        <div></div>
                        <button onclick="moveBox(0, 5)" class="bg-gray-200 active:bg-blue-200 p-3 rounded font-bold">↓</button>
                        <div></div>
                    </div>
                </div>

                <hr>

                <div>
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Adjust Size</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <span class="text-xs text-center">Width</span>
                            <div class="flex gap-1">
                                <button onclick="resizeBox(-5, 0)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">-</button>
                                <button onclick="resizeBox(5, 0)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">+</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-xs text-center">Height</span>
                            <div class="flex gap-1">
                                <button onclick="resizeBox(0, -5)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">-</button>
                                <button onclick="resizeBox(0, 5)" class="bg-gray-200 active:bg-blue-200 py-3 flex-1 rounded font-bold">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="processPDF()" class="w-full bg-green-600 text-white text-lg font-bold py-4 rounded-lg shadow mt-4 active:bg-green-800">
                    Apply & Download
                </button>
                <p id="status" class="text-center text-sm text-gray-500 mt-2"></p>
            </div>
        </div>
    </div>

    <script>
        // ================= PWA INSTALL LOGIC =================
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        // Check if service worker is supported and register it
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }

        // Listen for the event that allows installation
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI notify the user they can add to home screen
            installBtn.classList.remove('hidden');
        });

        installBtn.addEventListener('click', (e) => {
            // hide our user interface that shows our A2HS button
            installBtn.classList.add('hidden');
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });

        // If app is already installed, ensure button is hidden
        window.addEventListener('appinstalled', (evt) => {
             installBtn.classList.add('hidden');
        });

        // ================= PDF APP LOGIC =================
        let pdfData = null;
        let pdfPageHeight = 0;
        let canvasScale = 1.0;

        // Current state of the box 
        let box = { x: 20, y: 20, w: 100, h: 40 };

        const fileInput = document.getElementById('pdfInput');
        const editorArea = document.getElementById('editor-area');
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');
        const maskBox = document.getElementById('mask-box');
        const colorPicker = document.getElementById('colorPicker');

        // Update preview box color instantly on selection
        colorPicker.addEventListener('input', (e) => {
            // Use some transparency for preview so we can see what we are covering
            const hex = e.target.value;
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            maskBox.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.7)`;
        });

        // Helper: Convert Hex to PDF-Lib RGB (0-1 range)
        function hexToPdfColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return PDFLib.rgb(r, g, b);
        }

        // --- 1. HANDLE UPLOAD ---
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            const file = e.target.files[0];
            pdfData = await file.arrayBuffer();

            const loadingTask = pdfjsLib.getDocument({ data: pdfData });
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);

            // Scale logic: Fit to screen width (minus padding)
            const viewportRaw = page.getViewport({ scale: 1 });
            const screenWidth = window.innerWidth - 40; 
            canvasScale = screenWidth / viewportRaw.width;
            if (canvasScale > 2) canvasScale = 2;

            const viewport = page.getViewport({ scale: canvasScale });

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pdfPageHeight = viewportRaw.height;

            const renderContext = { canvasContext: ctx, viewport: viewport };
            await page.render(renderContext).promise;
            
            // Initialize Box Position (Center it roughly)
            box.x = (viewport.width / 2) - 50;
            box.y = (viewport.height / 2) - 20;
            updateBoxVisual();
            
            // Initialize preview color based on default picker value
            colorPicker.dispatchEvent(new Event('input'));

            editorArea.classList.remove('hidden');
        });

        // --- 2. CONTROL FUNCTIONS ---
        function moveBox(dx, dy) {
            box.x += dx * 2; 
            box.y += dy * 2;
            updateBoxVisual();
        }

        function resizeBox(dw, dh) {
            box.w += dw * 2;
            box.h += dh * 2;
            if (box.w < 10) box.w = 10;
            if (box.h < 10) box.h = 10;
            updateBoxVisual();
        }

        function updateBoxVisual() {
            maskBox.style.left = box.x + 'px';
            maskBox.style.top = box.y + 'px';
            maskBox.style.width = box.w + 'px';
            maskBox.style.height = box.h + 'px';
        }

        // --- 3. PROCESS & DOWNLOAD ---
        async function processPDF() {
            if (!pdfData) return;
            const status = document.getElementById('status');
            status.innerText = "Processing...";

            try {
                const pdfDoc = await PDFLib.PDFDocument.load(pdfData);
                const pages = pdfDoc.getPages();

                // Get selected color
                const selectedColor = hexToPdfColor(colorPicker.value);

                // Convert Screen Pixels -> PDF Points
                const pdfX = box.x / canvasScale;
                const pdfW = box.w / canvasScale;
                const pdfH = box.h / canvasScale;
                const visualYOnPdf = box.y / canvasScale;
                const finalY = pdfPageHeight - (visualYOnPdf + pdfH);

                pages.forEach(page => {
                    page.drawRectangle({
                        x: pdfX,
                        y: finalY,
                        width: pdfW,
                        height: pdfH,
                        color: selectedColor, // Use chosen color
                        opacity: 1, // Solid opacity for final PDF
                    });
                });

                const pdfBytes = await pdfDoc.save();
                download(pdfBytes, "masked_file.pdf");
                status.innerText = "Done! Downloading...";

            } catch (err) {
                console.error(err);
                status.innerText = "Error.";
                alert("An error occurred.");
            }
        }

        function download(data, filename) {
            const blob = new Blob([data], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
